<html><head></head><body>{% extends "layouts/privateLayout.njk" %}

{% block content %}
<h1>Lista de Roles</h1>
<button id="addRoleBtn">Agregar Rol</button>
<div id="roleTableContainer"></div>
<div id="snackbar" class="snackbar"></div>

<!-- Modal para agregar/editar roles -->
<div class="modal" id="addRoleModal" style="display:none;">
    <div class="modal-content">
        <span class="close-button" onclick="Modal.close('#addRoleModal')">×</span>
        <h2 id="modalTitle">Agregar Rol</h2>
        <form id="roleForm">
            <label for="roleName">Nombre:</label>
            <input type="text" id="roleName" name="name" required="">
            
            <label for="roleAlias">Alias:</label>
            <input type="text" id="roleAlias" name="alias" required="">

            <label for="roleDescription">Descripción:</label>
            <input type="text" id="roleDescription" name="description">

            <!-- Eliminamos el contenedor de permisos en el primer modal -->
            <button type="button" id="selectPermissionsBtn">Seleccionar Permisos</button> <!-- Cambiado a "Seleccionar Permisos" -->
            <button type="button" id="saveRoleBtn">Guardar</button>
        </form>
    </div>
</div>

<!-- Modal para seleccionar permisos -->
<div class="modal" id="selectPermissionsModal" style="display:none;">
    <div class="modal-content">
        <span class="close-button" onclick="Modal.close('#selectPermissionsModal')">×</span>
        <h2 id="permissionsModalTitle">Seleccionar Permisos</h2> <!-- Cambiado dinámicamente dependiendo de la acción -->
        <div id="permissionsContainer"></div> <!-- Aquí irán los checkboxes de permisos -->
        <button type="button" id="savePermissionsBtn">Guardar Permisos</button>
    </div>
</div>

<script type="module">
    import { fetchRoles, createRole, updateRoleService } from './js/services/roleService.js';
    import { fetchPermissions } from './js/services/permissionService.js';
    import { getState } from './js/reducers/state.js';
    import { renderTable } from './js/renderTable.js';

    const roleHeaders = {
        name: 'Nombre',
        alias: 'Alias',
        description: 'Descripción',
        permissions: 'Permisos',
        isActive: 'Estado',
    };

    let currentEditingRoleId = null; 
    let selectedPermissions = []; 

    document.addEventListener('DOMContentLoaded', () => {
        loadRoles();
        setupEventListeners();
    });

    const loadRoles = async () => {
        await fetchRoles();
        const { roles } = getState();
        renderTable(roles, roleHeaders, 'roleTableContainer', onAction);
    };

    const setupEventListeners = () => {
        document.getElementById('addRoleBtn').addEventListener('click', () => {
            currentEditingRoleId = null; 
            clearRoleForm();
            loadPermissions(); 
            document.getElementById('modalTitle').textContent = 'Agregar Rol'; 
            document.getElementById('permissionsModalTitle').textContent = 'Seleccionar Permisos';
            Modal.open('#addRoleModal'); 
        });

        document.getElementById('saveRoleBtn').addEventListener('click', saveRole);
        document.getElementById('selectPermissionsBtn').addEventListener('click', openPermissionsModal); 
        document.getElementById('savePermissionsBtn').addEventListener('click', saveSelectedPermissions);
    };

    const clearRoleForm = () => {
        document.getElementById('roleName').value = ''; 
        document.getElementById('roleAlias').value = ''; 
        document.getElementById('roleDescription').value = '';
        clearPermissionsSelection(); 
    };

    const clearPermissionsSelection = () => {
        selectedPermissions = []; 
    };

    const onAction = async (action, id) => {
        const roles = getState().roles;
        const selectedRole = roles.find(role => role._id === id);
        
        if (action === 'edit') {
            
            document.getElementById('roleName').value = selectedRole.name;
            document.getElementById('roleAlias').value = selectedRole.alias;
            document.getElementById('roleDescription').value = selectedRole.description;
            currentEditingRoleId = id; 
            
            
            await loadPermissions();

            
            selectedPermissions = selectedRole.permissions.map(p => p._id);
            document.getElementById('permissionsModalTitle').textContent = 'Modificar Permisos';
            
            Modal.open('#addRoleModal'); 
        }
    };

    
    const loadPermissions = async () => {
        await fetchPermissions(); 
        const { permissions } = getState(); 
        renderPermissionsCheckboxesForSelection(permissions); 
    };

    
    const renderPermissionsCheckboxesForSelection = (permissions) => {
        const container = document.getElementById('permissionsContainer');
        container.innerHTML = ''; 

        permissions.forEach(permission => {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `selectPermission-${permission._id}`;
            checkbox.value = permission._id;

            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = permission.name;

            
            checkbox.checked = selectedPermissions.includes(permission._id);

            container.appendChild(checkbox);
            container.appendChild(label);
            container.appendChild(document.createElement('br'));
        });
    };

    const openPermissionsModal = () => {
        const { permissions } = getState(); 
        renderPermissionsCheckboxesForSelection(permissions);
        Modal.open('#selectPermissionsModal'); 
    };

    const saveSelectedPermissions = () => {
        const checkboxes = document.querySelectorAll('#permissionsContainer input[type="checkbox"]:checked');
        selectedPermissions = Array.from(checkboxes).map(checkbox => checkbox.value); 
        Modal.close('#selectPermissionsModal'); 
    };

    const saveRole = async () => {
        const name = document.getElementById('roleName').value.trim();
        const alias = document.getElementById('roleAlias').value.trim();
        const description = document.getElementById('roleDescription').value.trim();
        
        
        if (!name || !alias || selectedPermissions.length === 0) {
            showSnackbar('Por favor, complete todos los campos y seleccione al menos un permiso.', false);
            return;
        }

        const data = { name, alias, description, permissions: selectedPermissions };

        try {
            let message;
            if (currentEditingRoleId) {
                data._id = currentEditingRoleId; 
                message = await updateRoleService(data);
            } else {
                message = await createRole(data);
            }

            if (message) {
                Modal.close('#addRoleModal');
                await loadRoles(); 
                showSnackbar(message, true);
            } else {
                showSnackbar('Error al guardar el rol.', false);
            }
        } catch (error) {
            console.error('Error al guardar el rol:', error);
            showSnackbar('Error al guardar el rol.', false);
        }
    };

    
    window.onAction = onAction;

</script>

{% endblock %}
</body></html>