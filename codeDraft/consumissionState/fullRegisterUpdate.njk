<html><head></head><body>{% extends "layouts/privateLayout.njk" %}

{% block content %}
<h1>Lista de Roles</h1>
<button id="addRoleBtn">Agregar Rol</button>
<div id="roleTableContainer"></div>
<div id="snackbar" class="snackbar"></div>

<!-- Modal para agregar/editar roles -->
<div class="modal" id="addRoleModal" style="display:none;">
    <div class="modal-content">
        <span class="close-button" onclick="Modal.close('#addRoleModal')">×</span>
        <h2 id="modalTitle">Agregar Rol</h2>
        <form id="roleForm">
            <label for="roleName">Nombre:</label>
            <input type="text" id="roleName" name="name" required="">
            
            <label for="roleAlias">Alias:</label>
            <input type="text" id="roleAlias" name="alias" required="">

            <label for="roleDescription">Descripción:</label>
            <input type="text" id="roleDescription" name="description">

            <!-- Eliminamos el contenedor de permisos en el primer modal -->
            <button type="button" id="selectPermissionsBtn">Seleccionar Permisos</button> <!-- Cambiado a "Seleccionar Permisos" -->
            <button type="button" id="saveItemBtn">Guardar</button>
        </form>
    </div>
</div>

<!-- Modal para seleccionar permisos -->
<div class="modal" id="selectPermissionsModal" style="display:none;">
    <div class="modal-content">
        <span class="close-button" onclick="Modal.close('#selectPermissionsModal')">×</span>
        <h2 id="permissionsModalTitle">Seleccionar Permisos</h2> <!-- Cambiado dinámicamente dependiendo de la acción -->
        <div id="permissionsContainer"></div> <!-- Aquí irán los checkboxes de permisos -->
        <button type="button" id="savePermissionsBtn">Guardar Permisos</button>
    </div>
</div>
<script type="module">
    import { fetchRoles, createRole, updateRoleService } from './js/services/roleService.js';
    import { fetchPermissions } from './js/services/permissionService.js';
    import { getState } from './js/reducers/state.js';
    import { renderTable } from './js/renderTable.js';
    import { renderSubItemsCheckboxesForSelection } from './js/utils/subItemUtils.js'; 
    import { clearFormFields, resetFormFields, clearSelectionsAndArray } from './js/utils/formUtils.js'; 
    import { saveSelectedSubItems, saveItem } from './js/logic/itemLogic/index.js'; 

    const roleHeaders = {
        name: 'Nombre',
        alias: 'Alias',
        description: 'Descripción',
        permissions: 'Permisos',
        isActive: 'Estado',
    };

    let currentEditingRoleId = null; 
    let selectedPermissions = []; 

    document.addEventListener('DOMContentLoaded', () => {
        loadRoles();
        setupEventListeners();
    });

    const loadRoles = async () => {
        await fetchRoles();
        const { roles } = getState();
        renderTable(roles, roleHeaders, 'roleTableContainer', onAction);
    };

    const setupEventListeners = () => {
        document.getElementById('addRoleBtn').addEventListener('click', () => {
            currentEditingRoleId = null; 
            clearRoleForm();
            loadPermissions(); 
            document.getElementById('modalTitle').textContent = 'Agregar Rol'; 
            document.getElementById('permissionsModalTitle').textContent = 'Seleccionar Permisos';
            Modal.open('#addRoleModal'); 
        });

        document.getElementById('saveItemBtn').addEventListener('click', saveItemHandler);
        document.getElementById('selectPermissionsBtn').addEventListener('click', openPermissionsModal); 
        document.getElementById('savePermissionsBtn').addEventListener('click', savePermissionsHandler);
    };

    const clearRoleForm = () => {
        clearFormFields('roleForm'); 
        clearSelectionsAndArray('permissionsContainer', selectedPermissions); 
    };

    const onAction = async (action, id) => {
        const roles = getState().roles;
        const selectedRole = roles.find(role => role._id === id);
        
        if (action === 'edit') {
            
            resetFormFields(['roleName', 'roleAlias', 'roleDescription']); 
            document.getElementById('roleName').value = selectedRole.name;
            document.getElementById('roleAlias').value = selectedRole.alias;
            document.getElementById('roleDescription').value = selectedRole.description;
            currentEditingRoleId = id; 
            
            
            await loadPermissions();

            
            selectedPermissions = selectedRole.permissions.map(p => p._id);
            document.getElementById('permissionsModalTitle').textContent = 'Modificar Permisos';
            
            Modal.open('#addRoleModal'); 
        }
    };

    
    const loadPermissions = async () => {
        await fetchPermissions(); 
        const { permissions } = getState(); 
        renderSubItemsCheckboxesForSelection(permissions, selectedPermissions, 'permissionsContainer'); 
    };

    const openPermissionsModal = () => {
        const { permissions } = getState(); 
        renderSubItemsCheckboxesForSelection(permissions, selectedPermissions, 'permissionsContainer'); 
        Modal.open('#selectPermissionsModal'); 
    };

    
    const savePermissionsHandler = () => {
        selectedPermissions = saveSelectedSubItems('permissionsContainer', selectedPermissions); 
        Modal.close('#selectPermissionsModal'); 
    };

    
    const saveItemHandler = async () => {
        const name = document.getElementById('roleName').value.trim();
        const alias = document.getElementById('roleAlias').value.trim();
        const description = document.getElementById('roleDescription').value.trim();
        
        
        if (!name || !alias || selectedPermissions.length === 0) {
            showSnackbar('Por favor, complete todos los campos y seleccione al menos un permiso.', false);
            return;
        }

        const data = { name, alias, description, permissions: selectedPermissions };

        try {
            const message = await saveItem(data, currentEditingRoleId, updateRoleService, createRole);
            if (message) {
                Modal.close('#addRoleModal');
                await loadRoles(); 
                showSnackbar(message, true);
            } else {
                showSnackbar('Error al guardar el rol.', false);
            }
        } catch (error) {
            showSnackbar(error.message, false);
        }
    };

    
    window.onAction = onAction;

</script>


{% endblock %}
</body></html>