<h1>Lista de Usuarios</h1>
<hr />

<!-- Botón para agregar un nuevo usuario -->
<button id="addUserButton">Agregar Usuario</button>

<section>
    <div id="userTableContainer"></div>
</section>

<div id="snackbar" class="snackbar"></div>


<!-- Modal para crear un nuevo usuario -->
<div id="createUserModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Crear Nuevo Usuario</h2>
        <div id="createUserFormContainer"></div>
    </div>
</div>

<!-- Modal para editar usuarios -->
<div id="editUserModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Editar Usuario</h2>
        <div id="modalFormContainer"></div> <!-- Contenedor para el formulario -->
    </div>
</div>

<!-- Modal para confirmar eliminación de usuarios -->
<div id="deleteUserModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Confirmar Eliminación</h2>
        <p>¿Estás seguro de que deseas eliminar este usuario?</p>
        <button id="confirmDeleteButton">Confirmar</button>
        <button id="cancelDeleteButton">Cancelar</button>
    </div>
</div>

<!-- Modal para informar que es necesario reiniciar la sesión -->
<div id="sessionRestartModal" class="modal">
    <div class="modal-content">
        <h2>Es necesario reiniciar la sesión</h2>
        <p>Para aplicar los cambios en roles y permisos, es necesario que cierres sesión y vuelvas a ingresar.</p>
    </div>
</div>

<script>
$(document).ready(function() {
    let userToDelete = null;

    fetchUsers();

    $('#addUserButton').click(function() {
        renderCreateUserForm(); // Renderizar formulario de creación
        Modal.open('#createUserModal'); // Abrir el modal de creación
    });

    $(document).on('click', '.edit-button', function(e) {
        e.preventDefault();
        const userId = $(this).data('user-id');
        getUserInfo(userId); // Obtener datos del usuario
    });

    $(document).on('click', '.delete-button', function() {
        const userId = $(this).data('user-id');
        const userRow = $(this).closest('tr');
        userToDelete = { id: userId, row: userRow };
        Modal.open('#deleteUserModal'); // Abrir el modal de confirmación
    });

    $('#confirmDeleteButton').click(function() {
        if (userToDelete) {
            deleteUser(userToDelete.id, userToDelete.row);
            Modal.close('#deleteUserModal'); // Cerrar el modal después de confirmar
            userToDelete = null; // Reiniciar la variable
        }
    });

    $('#cancelDeleteButton').click(function() {
        Modal.close('#deleteUserModal'); // Cerrar el modal sin eliminar
        userToDelete = null; // Reiniciar la variable
    });

    function fetchUsers() {
        apiFetch('/users/getUsers', 'GET')
            .then(response => {
                const users = response.data || response.users || [];
                renderUserTable(users);
            })
            .catch(xhr => {
                console.error('Error al obtener los usuarios:', xhr);
            });
    }

    function renderUserTable(users) {
        let tableHtml = `
            <table>
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Apellidos</th>
                        <th>Email</th>
                        <th>Género</th>
                        <th>Roles</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
        `;

        users.forEach(user => {
            let rolesHtml = '<ul>';
            user.roles.forEach(role => {
                rolesHtml += `<li>${role.name}</li>`;
            });
            rolesHtml += '</ul>';

            tableHtml += `
                <tr>
                    <td>${user.name}</td>
                    <td>${user.surnames}</td>
                    <td>${user.email}</td>
                    <td>${user.gender}</td>
                    <td>${rolesHtml}</td>
                    <td>
                        <button class="edit-button" data-user-id="${user._id}">Editar</button>
                        <button class="delete-button" data-user-id="${user._id}">Eliminar</button>
                    </td>
                </tr>
            `;
        });

        tableHtml += '</tbody></table>';
        $('#userTableContainer').html(tableHtml);
    }

    function renderEditForm(user, allRoles, userId) {
        const rolesHtml = allRoles.map(role => `
            <label>
                <input type="checkbox" name="roles" value="${role._id}" 
                    ${user.roles.some(userRole => userRole.name === role.name) ? 'checked' : ''}>
                ${role.name}
            </label>
        `).join('');

        $('#modalFormContainer').html(`
            <form id="userUpdateForm" data-user-id="${userId}">
                <label for="name">Nombre:</label>
                <input type="text" id="name" name="name" value="${user.name}" required>
                <label for="surnames">Apellidos:</label>
                <input type="text" id="surnames" name="surnames" value="${user.surnames}" required>
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" value="${user.email}" required>
                <label for="gender">Género:</label>
                <select id="gender" name="gender" required>
                    <option value="masculino" ${user.gender === 'masculino' ? 'selected' : ''}>Masculino</option>
                    <option value="femenino" ${user.gender === 'femenino' ? 'selected' : ''}>Femenino</option>
                    <option value="otro" ${user.gender === 'otro' ? 'selected' : ''}>Otro</option>
                </select>
                <fieldset>
                    <legend>Roles:</legend>
                    ${rolesHtml}
                </fieldset>
                <button type="submit">Actualizar Usuario</button>
            </form>
        `);
    }

    function renderCreateUserForm() {
        // Obtener los roles disponibles
        apiFetch('/roles/api', 'GET')
            .then(response => {
                const roles = response.data || response.roles || [];
                const rolesHtml = roles.map(role => `
                    <label>
                        <input type="checkbox" name="roles" value="${role._id}">
                        ${role.name}
                    </label>
                `).join('');

                $('#createUserFormContainer').html(`
                    <form id="userCreateForm">
                        <label for="name">Nombre:</label>
                        <input type="text" id="name" name="name" required>
                        <label for="surnames">Apellidos:</label>
                        <input type="text" id="surnames" name="surnames" required>
                        <label for="email">Email:</label>
                        <input type="email" id="email" name="email" required>
                        <label for="password">Contraseña:</label>
                        <input type="password" id="password" name="password" required>
                        <label for="gender">Género:</label>
                        <select id="gender" name="gender" required>
                            <option value="masculino">Masculino</option>
                            <option value="femenino">Femenino</option>
                            <option value="otro">Otro</option>
                        </select>
                        <fieldset>
                            <legend>Roles:</legend>
                            ${rolesHtml}
                        </fieldset>
                        <button type="submit">Crear Usuario</button>
                    </form>
                `);
            })
            .catch(xhr => {
                const errorMessage = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Error al obtener los roles';
                showSnackbar(errorMessage, false);
            });
    }

    // Crear usuario
$(document).on('submit', '#userCreateForm', function(e) {
    e.preventDefault();

    const roles = $('input[name="roles"]:checked').map(function() {
        return this.value;
    }).get();

    const newUserData = {
        name: $('#name').val(),
        surnames: $('#surnames').val(),
        email: $('#email').val(),
        password: $('#password').val(),
        gender: $('#gender').val(),
        roles: roles,
    };

    // Aquí se captura la respuesta del servidor
    apiFetch('/users/create-user', 'POST', newUserData)
        .then(response => {
            // Capturar el mensaje del servidor en la respuesta
            showSnackbar(response.message, response.success);  // Mostrar el mensaje del servidor
            if (response.success) {
                fetchUsers(); // Actualizar la lista de usuarios
                Modal.close('#createUserModal'); // Cerrar el modal
            }
        })
        .catch(xhr => {
            // Capturar el mensaje de error desde el servidor (en caso de fallo)
            const errorMessage = xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : 'Error al crear el usuario';
            showSnackbar(errorMessage, false);  // Mostrar el mensaje de error del servidor
        });
});


    // Obtener información de usuario para editar
    function getUserInfo(userId) {
        apiFetch(`/users/${userId}`, 'GET')
            .then(response => {
                const user = response.data || response.user || {};
                return apiFetch('/roles/api', 'GET').then(roleResponse => {
                    const allRoles = roleResponse.data || roleResponse.roles || [];
                    renderEditForm(user, allRoles, userId);
                    Modal.open('#editUserModal'); // Abrir el modal de edición
                });
            })
            .catch(xhr => {
                const errorMessage = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Error al obtener información del usuario';
                showSnackbar(errorMessage, false);
            });
    }

    // Actualizar usuario
    $(document).on('submit', '#userUpdateForm', function(e) {
        e.preventDefault();

        const userId = $(this).data('user-id');
        const roles = $('input[name="roles"]:checked').map(function() {
            return this.value;
        }).get();

        const updatedUserData = {
            name: $('#name').val(),
            surnames: $('#surnames').val(),
            email: $('#email').val(),
            gender: $('#gender').val(),
            roles: roles,
        };

        apiFetch(`/users/update/${userId}`, 'PUT', updatedUserData)
            .then(response => {
                showSnackbar('Usuario actualizado exitosamente.', true);
                fetchUsers(); // Actualizar la lista de usuarios
                Modal.close('#editUserModal'); // Cerrar el modal
            })
            .catch(xhr => {
                const errorMessage = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Error al actualizar el usuario';
                showSnackbar(errorMessage, false);
            });
    });

    function deleteUser(userId, userRow) {
        apiFetch(`/users/delete/${userId}`, 'DELETE')
            .then(response => {
                showSnackbar('Usuario eliminado exitosamente.', true);
                userRow.remove(); // Eliminar la fila de usuario de la tabla
            })
            .catch(xhr => {
                const errorMessage = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Error al eliminar el usuario';
                showSnackbar(errorMessage, false);
            });
    }

    function showSnackbar(message, success) {
        const snackbar = $('#snackbar');
        snackbar.text(message).addClass(success ? 'success' : 'error').fadeIn(300).delay(3000).fadeOut(300, function() {
            $(this).removeClass('success error'); // Reiniciar clases después de desvanecerse
        });
    }

    const Modal = {
        open(modalId) {
            $(modalId).css('display', 'block');
        },
        close(modalId) {
            $(modalId).css('display', 'none');
        },
    };

    // Cerrar el modal al hacer clic en el botón de cerrar
    $('.close-button').click(function() {
        Modal.close($(this).closest('.modal'));
    });

    // Cerrar el modal al hacer clic fuera del contenido del modal
    $(window).click(function(event) {
        if ($(event.target).hasClass('modal')) {
            Modal.close('.modal');
        }
    });
});
</script>
