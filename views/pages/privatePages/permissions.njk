{% extends "layouts/privateLayout.njk" %}

{% block content %}
<h1>Lista de Permisos</h1>
<button id="addPermissionBtn">Agregar Permiso</button>
<div id="permissionTableContainer"></div>
<div id="snackbar" class="snackbar"></div>

<!-- Modal para agregar/editar permisos -->
<div class="modal" id="addPermissionModal" style="display:none;">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2 id="modalTitle">Agregar Permiso</h2>
        <form id="permissionForm">
            <label for="permissionName">Nombre:</label>
            <input type="text" id="permissionName" name="name" required>
            
            <label for="permissionDescription">Descripción:</label>
            <input type="text" id="permissionDescription" name="description" required>
            
            <button type="button" id="saveGenericBtn">Guardar</button>
        </form>
    </div>
</div>

<script type="module">
    import { fetchAndRenderData, fetchData } from './js/apiUserManager.js';
    import { renderTable } from './js/renderTable.js';
    import { loadEndpoints } from './js/endpoints/loadEndpoints.js';
    import { openGenericForm, closeGenericForm } from './js/forms/genericForm.js';
    import { saveResource, updateResource } from './js/api/resourceHandler.js'; // Importar el manejador de recursos
  

    const permissionHeaders = {
        name: 'Nombre',
        description: 'Descripción',
        isActive: 'Estado',
    };

    const fields = [
        { id: 'permissionName', name: 'name', label: 'Nombre' },
        { id: 'permissionDescription', name: 'description', label: 'Descripción' }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        loadPermissions();
        setupEventListeners();
    });

    const loadPermissions = async () => {
        const endpoint = loadEndpoints('permissions', 'list');
        await fetchAndRenderData(
            endpoint,
            (data) => renderTable(data, permissionHeaders, 'permissionTableContainer', onAction),
            permissionHeaders
        );
    };

    const setupEventListeners = () => {
        document.getElementById('addPermissionBtn').addEventListener('click', () => {
            document.getElementById('modalTitle').innerText = 'Agregar Permiso';
            openGenericForm('#addPermissionModal', fields, savePermission);
        });

        document.querySelector('.close-button').addEventListener('click', () => {
            closeGenericForm('#addPermissionModal');
        });
    };

    const onAction = async (action, id) => {
        try {
            if (action === 'edit') {
                const endpoint = loadEndpoints('permissions', 'details', id);
                const permissionData = await fetchData(endpoint);

                if (permissionData) {
                    document.getElementById('modalTitle').innerText = 'Editar Permiso';
                    openGenericForm('#addPermissionModal', fields, (updatedData) => updatePermissionHandler(id, updatedData), permissionData);
                } else {
                    console.error("No se pudo recuperar el permiso.");
                }
            }
            // Otras acciones...
        } catch (error) {
            console.error(error);
            showSnackbar(error.message || 'Error al procesar la acción.', false);
        }
    };
const savePermission = async (data) => {
    const result = await saveResource('permissions', data); // Usar la función generalizada

    console.log("Resultado de la operación:", result); // Para depuración

    if (result && result.success) {
        loadPermissions(); // Recargar la tabla
        closeGenericForm('#addPermissionModal'); // Cerrar el modal solo después de guardar exitosamente
        showSnackbar(result.message || 'Permiso agregado correctamente.', true); // Mostrar Snackbar
    } else {
        showSnackbar(result ? result.message : 'Error al agregar el permiso.', false); // Mostrar error
    }

    return result; // Devuelve el resultado para que handleForm lo maneje
};

const updatePermissionHandler = async (id, data) => {
    const result = await updateResource('permissions', id, data); // Usar la función generalizada

    console.log("Resultado de la operación de actualización:", result); // Para depuración

    if (result && result.success) {
        loadPermissions(); // Recargar la tabla
        closeGenericForm('#addPermissionModal'); // Cerrar el modal solo después de actualizar exitosamente
        showSnackbar(result.message || 'Permiso actualizado correctamente.', true); // Mostrar Snackbar
    } else {
        showSnackbar(result ? result.message : 'Error al actualizar el permiso.', false); // Mostrar error
    }

    return result; // Devuelve el resultado para que handleForm lo maneje
};


    // Hacer que onAction sea global
    window.onAction = onAction; // Esto lo hace accesible globalmente
</script>
{% endblock %}
