{% extends "layouts/privateLayout.njk" %}

{% block content %}
<h1>Lista de Permisos</h1>
<button id="addPermissionBtn">Agregar Permiso</button>
<div id="permissionTableContainer"></div>
<div id="snackbar" class="snackbar"></div>

<!-- Modal para agregar permisos -->
<div class="modal" id="addPermissionModal" style="display:none;">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Agregar Permiso</h2>
        <label for="permissionName">Nombre:</label>
        <input type="text" id="permissionName" required>
        
        <label for="permissionDescription">Descripción:</label>
        <input type="text" id="permissionDescription" required>
        
        <button id="savePermissionBtn">Guardar</button>
    </div>
</div>

<script type="module">
    import { fetchPermissions, createPermission } from './js/services/permissionService.js'; // Ajusta la ruta según tu estructura
    import { getState } from './js/reducers/state.js';
    import { renderTable } from './js/renderTable.js'; // Ajusta la ruta según tu estructura

    const permissionHeaders = {
        name: 'Nombre',
        description: 'Descripción',
        isActive: 'Estado',
    };

    document.addEventListener('DOMContentLoaded', () => {
        loadPermissions();
        setupEventListeners();
    });

    const loadPermissions = async () => {
        await fetchPermissions();
        const { permissions } = getState(); // Obtener permisos del estado
        renderTable(permissions, permissionHeaders, 'permissionTableContainer'); // Renderizar permisos
    };

    const setupEventListeners = () => {
        document.getElementById('addPermissionBtn').addEventListener('click', () => {
            Modal.open('#addPermissionModal'); // Abre el modal para agregar permiso
        });

        document.getElementById('savePermissionBtn').addEventListener('click', savePermission);
    };

 const savePermission = async () => {
    const name = document.getElementById('permissionName').value.trim();
    const description = document.getElementById('permissionDescription').value.trim();

    if (!name || !description) {
        showSnackbar('Por favor, complete todos los campos.', false);
        return;
    }

    const data = { name, description };
    const message = await createPermission(data); // Llama al servicio para crear permiso

    if (message) {
        Modal.close('#addPermissionModal'); // Cierra el modal
        loadPermissions(); // Recargar la tabla
        showSnackbar(message, true); // Mostrar mensaje del servidor
    } else {
        showSnackbar('Error al agregar el permiso.', false); // Mostrar mensaje de error
    }
};

</script>
{% endblock %}
